<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Histórico de Pedidos</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet" />

    <style>
        body {
            padding: 20px;
        }

        .card {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="container">

        <h1 class="mb-4">Histórico de Pedidos</h1>

        <button class="btn btn-secondary mb-3" onclick="carregarPedidos()">Recarregar</button>

        <div id="lista-pedidos"></div>
        <div id="erro" class="text-danger"></div>

    </div>

    <script>function formatarData(dataISO) {
    const d = new Date(dataISO);
    return d.toLocaleString("pt-BR");
}

async function carregarPedidos() {
    const container = document.getElementById("lista-pedidos");
    const erro = document.getElementById("erro");
    container.innerHTML = "";
    erro.textContent = "";

    try {
        const resp = await fetch("/api/Pedidos");
        if (!resp.ok) throw new Error("Erro ao buscar pedidos.");

        const pedidos = await resp.json();

        if (pedidos.length === 0) {
            container.innerHTML = "<p>Nenhum pedido encontrado.</p>";
            return;
        }

        pedidos.forEach(p => {
            const card = document.createElement("div");
            card.className = "card";

            card.innerHTML = `
                <div class="card-header">
                    Pedido #${p.id} — ${p.nomeCliente}
                </div>
                <div class="card-body">
                    <p><strong>Data:</strong> ${formatarData(p.dataCriacao)}</p>
                    <p><strong>Valor Total:</strong> R$ ${p.valorTotal.toFixed(2)}</p>

                    <h5>Itens:</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Qtd</th>
                                <th>Preço</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${p.itens
                                .map(
                                    item => `
                                <tr>
                                    <td>${item.produto ? item.produto.nome : "ID " + item.produtoId}</td>
                                    <td>${item.quantidade}</td>
                                    <td>R$ ${item.precoUnitario.toFixed(2)}</td>
                                    <td>R$ ${item.subtotal.toFixed(2)}</td>
                                </tr>
                            `
                                )
                                .join("")}
                        </tbody>
                    </table>
                </div>
            `;

            container.appendChild(card);
        });

    } catch (e) {
        erro.textContent = e.message;
    }
}

carregarPedidos();</script>

</body>
</html>