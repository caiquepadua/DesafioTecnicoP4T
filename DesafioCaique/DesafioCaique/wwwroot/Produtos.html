<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Gestão de Produtos</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
          rel="stylesheet" />

    <style>
        body {
            padding: 20px;
        }

        .btn-delete {
            cursor: pointer;
            color: red;
            font-size: 1.3rem;
        }

            .btn-delete:hover {
                color: darkred;
            }

        .btn-edit {
            cursor: pointer;
            font-size: 1.3rem;
        }

            .btn-edit:hover {
                color: #0a53be;
            }
    </style>
</head>
<body>

    <div class="container">

        <h1 class="mb-4">Gerenciar Produtos</h1>

        <!-- Formulário de criação -->
        <div class="card mb-4">
            <div class="card-header">Cadastrar / Editar Produto</div>
            <div class="card-body">

                <form id="formProduto" onsubmit="salvarProduto(event)">
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Nome</label>
                            <input id="nome" class="form-control" required />
                        </div>

                        <div class="col">
                            <label class="form-label">Descrição</label>
                            <input id="descricao" class="form-control" required />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Preço</label>
                            <input id="preco" type="number" min="0" step="0.01" class="form-control" required />
                        </div>

                        <div class="col">
                            <label class="form-label">Quantidade em estoque</label>
                            <input id="estoque" type="number" min="0" class="form-control" required />
                        </div>
                    </div>

                    <button id="btnSalvar" class="btn btn-primary w-100" type="submit">Criar Produto</button>
                </form>

            </div>
        </div>

        <!-- Estoque atual -->
        <div class="card">
            <div class="card-header">
                Estoque Atual
                <button class="btn btn-sm btn-secondary float-end" onclick="carregarProdutos()">Recarregar</button>
            </div>

            <div class="card-body">
                <table class="table table-striped" id="tabela-produtos">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Descrição</th>
                            <th>Preço</th>
                            <th>Estoque</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS preenche aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="erro" class="text-danger mt-3"></div>

    </div>

    <!-- JS -->
    <script>
        let modoEdicao = false;
        let idEmEdicao = null;

        async function carregarProdutos() {
            const tabela = document.querySelector("#tabela-produtos tbody");
            const erro = document.getElementById("erro");
            erro.textContent = "";
            tabela.innerHTML = "";

            try {
                const resp = await fetch("/api/Produtos");
                if (!resp.ok) throw new Error("Erro ao carregar produtos.");

                const produtos = await resp.json();

                produtos.forEach(produto => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                    <td>${produto.id}</td>
                    <td>${produto.nome}</td>
                    <td>${produto.descricao}</td>
                    <td>R$ ${produto.preco.toFixed(2)}</td>
                    <td>${produto.quantidadeEstoque}</td>
                    <td>
                        <i class="bi bi-pencil-square text-primary me-2 btn-edit"
                           onclick="entrarEmEdicao(${produto.id})"></i>

                        <i class="bi bi-trash btn-delete"
                           onclick="confirmarExclusao(${produto.id}, '${produto.nome}')"></i>
                    </td>
                `;

                    tabela.appendChild(tr);
                });

            } catch (e) {
                erro.textContent = e.message;
            }
        }

        async function entrarEmEdicao(id) {
            const erro = document.getElementById("erro");
            erro.textContent = "";

            try {
                const resp = await fetch(`/api/Produtos/${id}`);
                if (!resp.ok) throw new Error("Erro ao carregar produto.");

                const produto = await resp.json();

                document.getElementById("nome").value = produto.nome;
                document.getElementById("descricao").value = produto.descricao;
                document.getElementById("preco").value = produto.preco;
                document.getElementById("estoque").value = produto.quantidadeEstoque;

                modoEdicao = true;
                idEmEdicao = id;

                const btn = document.getElementById("btnSalvar");
                btn.textContent = "Salvar Alterações";
                btn.classList.remove("btn-primary");
                btn.classList.add("btn-warning");

            } catch (e) {
                erro.textContent = e.message;
            }
        }

        async function salvarProduto(event) {
            event.preventDefault();

            const produto = {
                nome: document.getElementById("nome").value,
                descricao: document.getElementById("descricao").value,
                preco: parseFloat(document.getElementById("preco").value),
                quantidadeEstoque: parseInt(document.getElementById("estoque").value)
            };

            let resp;

            try {
                if (!modoEdicao) {
                    resp = await fetch("/api/Produtos", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(produto)
                    });
                } else {
                    produto.id = idEmEdicao;

                    resp = await fetch(`/api/Produtos/${idEmEdicao}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(produto)
                    });
                }

                if (!resp.ok) {
                    alert("Erro ao salvar produto.");
                    return;
                }

                alert(!modoEdicao ? "Produto cadastrado!" : "Produto atualizado!");

                resetarFormulario();
                carregarProdutos();

            } catch (e) {
                alert("Erro ao salvar o produto.");
            }
        }

        function resetarFormulario() {
            document.getElementById("formProduto").reset();
            modoEdicao = false;
            idEmEdicao = null;

            const btn = document.getElementById("btnSalvar");
            btn.textContent = "Criar Produto";
            btn.classList.remove("btn-warning");
            btn.classList.add("btn-primary");
        }

        async function confirmarExclusao(id, nomeProduto) {
            const confirmar = confirm(`Tem certeza que deseja excluir o produto: "${nomeProduto}" ?`);
            if (!confirmar) return;

            try {
                const resp = await fetch(`/api/Produtos/${id}`, { method: "DELETE" });

                if (!resp.ok) {
                    alert("Erro ao excluir produto.");
                    return;
                }

                alert("Produto removido com sucesso!");
                carregarProdutos();

            } catch (e) {
                alert("Erro ao excluir o produto.");
            }
        }

        // Carrega os produtos ao abrir a página
        carregarProdutos();
    </script>

</body>
</html>
